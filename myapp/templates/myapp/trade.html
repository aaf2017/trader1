{% extends 'myapp/base.html' %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/trade.css' %}">


<div class="text-center">

  <h1>TRADE STOCKS</h1>
  <br/>

  <h4>Balance: {{ account.balance }} USD</h4>
  <br/>
    <form action="trade" method="POST">
      {% csrf_token %} <!--added/look at views.py/def trader-->
      <div class="form-inline">
        
        <div class="col-sm-12">
          <input type="text" name="symbol" class="form-control mr-sm-4" id="colFormLabel" placeholder="Enter Ticker">
          <input type="hidden" name="action" value="search">
          <button class="btn btn-outline-success my-2 my-sm-0" type="submit" value="search">Search</button>
        </div>
      </div>
    </form>
  <br/>
  <br/>

  {% if stock_quote.symbol %}
      <h3>{{ stock_quote.symbol }}</h3>
  {% else %}
      <h3>Ticker: n/a</h3>
  {% endif %}

  {% if stock_quote %}
    <table class="table table-striped table-responsive">
      <thead>
        <tr>
          <th scope="col">Ticker</th>
          <th scope="col">Previous Close</th>
          <th scope="col">Open</th>
          <th scope="col">Bid</th>
          <th scope="col">Ask</th>
          <th scope="col">52wkHigh</th>
          <th scope="col">52wkLow</th>
          <th scope="col">52wk Change</th>
          <th scope="col">Volume</th>
          <th scope="col">Reg.Market Price</th>
          <th scope="col">Share Outstanding</th>
          <th scope="col">Ex-Dividend Date</th>
          <th scope="col">Divident Yield</th>
        </tr>
      </thead>
      <tbody>

      
        <tr>
          <td>{{ stock_quote.symbol }}</td>
          <td>{{ stock_quote.previousClose }}</td>
          <td>{{ stock_quote.open }}</td>
          <td>{{ stock_quote.bid }}</td>
          <td>{{ stock_quote.ask }}</td>
          <td>{{ stock_quote.fiftyTwoWeekHigh }}</td>
          <td>{{ stock_quote.fiftyTwoWeekLow }}</td>
          <td>{{ stock_quote.fiftyTwoWeekChange }}</td>
          <td>{{ stock_quote.volume }}</td>
          <td>{{ stock_quote.regularMarketPrice }}</td>
          <td>{{ stock_quote.sharesOutstanding }}</td>
          {% if stock_quote.exDividendDate %}
            <td>{{ stock_quote.exDividendDate }}</td>
          {% else %}
            <td>N/A</td>
          {% endif %}
          {% if stock_quote.dividendYield %}
            <td>{{ stock_quote.dividendYield }}</td>
          {% else %}
            <td>N/A</td>
          {% endif %}

        </tr>
      {% for stock_quote in symbol %}
      {% endfor %}
      </tbody>
    </table>
{% else %}
  <table class="table table-striped table-responsive">
      <thead>
        <tr>
          <th scope="col">Ticker</th>
          <th scope="col">Previous Close</th>
          <th scope="col">Open</th>
          <th scope="col">Bid</th>
          <th scope="col">Ask</th>
          <th scope="col">52wkHigh</th>
          <th scope="col">52wkLow</th>
          <th scope="col">52wk Change</th>
          <th scope="col">Volume</th>
          <th scope="col">Reg.Market Price</th>
          <th scope="col">Share Outstanding</th>
          <th scope="col">Ex-Dividend Date</th>
          <th scope="col">Divident Yield</th>
        </tr>
      </thead>
      <tbody>

      
        <tr>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
         
        </tr>
      </tbody>
    </table>
    <br/>
    


{% endif %}



  <form action="trade" method="POST">
        
      <div class="container">
        </br>
        <div class="col-3 offset-9">
         
            
            <input type="text" name="total" class="form-control mr-sm-4" id="total-price-input" placeholder="$ Total Price" disabled> 
         
        </div>
        <br/>

        <div class="col-3 offset-9">
         
            <input type="text" name="quantity" class="form-control mr-sm-4" id="quantity-input" placeholder="Enter Quantity">
          
        </div>
        <br/>

        <div class="col-1 offset-11">
            <button class="btn btn-lg btn-primary btn-danger" type="button" id="buy-submit-button" aria-haspopup="true" aria-expanded="false">
                Buy
            </button>
        </div>
        

      </div>

  </form>
  <br/>
  <br/>
  <h5 id="buy-message"></h5>
</div>
<script type="text/javascript">
  var askPrice = 0
  var stock_data = {{ stock_quote | safe }}
  askPrice = stock_data && stock_data.ask ? stock_data.ask : askPrice
  $("#quantity-input").on("keyup", function(evt){
    let price = $("#quantity-input").val() * askPrice;
    $("#total-price-input").val(price); 
  })

  $("#buy-submit-button").on("click", function(evt){
    let quantity = $("#quantity-input").val() * 1
    
    $.ajax({ 
      url: "/buy_stocks",
      method: "POST",
      data: JSON.stringify({
        symbol: stock_data.symbol,
        quantity: quantity,
        ask: stock_data.ask
      }),
      dataType: "json",
    }).then(data => {
      if(data){
        $("#buy-message").text("You have successfully completed your purchase!")
      }
    })
  });

</script>
{% endblock %}

